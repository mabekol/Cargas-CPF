<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizador de Carga CPF - 50kVA</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #d32f2f;
            --success: #2e7d32;
            --warning: #f57c00;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 700px;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .summary-card {
            position: sticky;
            top: 10px;
            z-index: 100;
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .summary-card.overload {
            border-color: var(--danger);
            background-color: #fff5f5;
        }

        .progress-container {
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.4s ease, background-color 0.4s ease;
            width: 0%;
        }

        .table-section {
            background: var(--card);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .section-title {
            background: #f8fafc;
            padding: 10px 15px;
            font-weight: 700;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            color: var(--primary);
        }

        .load-row {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .load-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .area-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .tech-specs {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 2px;
        }

        .kva-vals {
            font-size: 0.8rem;
            text-align: right;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        input[type="range"] {
            flex-grow: 1;
            height: 6px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .percentage-input {
            width: 50px;
            padding: 4px;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .restricted-val {
            min-width: 80px;
            text-align: right;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 20px;
            padding-bottom: 30px;
        }

        @media (max-width: 480px) {
            .load-info {
                flex-direction: column;
                gap: 5px;
            }
            .kva-vals {
                text-align: left;
                display: flex;
                gap: 15px;
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 style="margin:0; font-size: 1.4rem;">Optimizador de Carga CPF</h1>
        <p style="color: #64748b; margin: 5px 0 0 0; font-size: 0.9rem;">Generador Disponible: <strong>50 kVA</strong></p>
        <p style="color: #64748b; margin: 2px 0 0 0; font-size: 0.8rem;">Capacidad Total Instalada: 111.74 kVA</p>
    </header>

    <div id="summary" class="summary-card">
        <div style="display: flex; justify-content: space-between; align-items: baseline;">
            <span style="font-size: 1rem;">Uso Actual: <strong><span id="total-kva" style="font-size: 1.2rem;">0.00</span> kVA</strong></span>
            <span id="usage-percent" style="font-size: 1.2rem; font-weight: 800;">0%</span>
        </div>
        <div class="progress-container">
            <div id="main-progress" class="progress-bar"></div>
        </div>
        <div id="status-msg" style="font-size: 0.85rem; text-align: center; font-weight: 600;">Calculando...</div>
    </div>

    <div id="tables-container">
        </div>

    <footer>
        Preservación y Seguridad Física &bull; Diagnóstico de Facilidad
    </footer>
</div>

<script>
    // Constantes globales
    const GENERATOR_CAPACITY = 50;
    const R3_STANDARD = 1.73; // Valor actualizado según la nueva tabla

    // Datos actualizados según la nueva imagen (111.74 kVA total)
    // 'initial' se configura según la columna "PORCENTAJE USO CARGA" de la imagen provista.
    const data = [
        {
            title: "Sistema 480V",
            items: [
                { id: 1, area: "PTARI", v: 480, i: 8, r3: R3_STANDARD, initial: 0 },
                { id: 2, area: "Planta PTAP", v: 480, i: 4, r3: R3_STANDARD, initial: 50 },
                { id: 3, area: "Planta PTARD", v: 480, i: 6, r3: R3_STANDARD, initial: 50 },
                { id: 4, area: "Alumbrado Perimetral", v: 480, i: 5, r3: R3_STANDARD, initial: 50 },
                { id: 5, area: "Bomba Cargadero", v: 480, i: 18, r3: R3_STANDARD, initial: 0 },
                { id: 6, area: "Compresor Facilidades", v: 480, i: 17, r3: R3_STANDARD, initial: 0 },
                { id: 17, area: "Ventilador TEA", v: 480, i: 20, r3: R3_STANDARD, initial: 0 } // Nueva Carga
            ]
        },
        {
            title: "Sistema 220V",
            items: [
                { id: 7, area: "Casino", v: 220, i: 52, r3: R3_STANDARD, initial: 15 },
                { id: 8, area: "TDL 1 (Hab 1-3-5-7)", v: 220, i: 3.6, r3: R3_STANDARD, initial: 100 },
                { id: 9, area: "TDL 2 (Hab 2-4-6-8)", v: 220, i: 4.33, r3: R3_STANDARD, initial: 0 },
                { id: 10, area: "TDL 3 (Hab 9-10-11-12)", v: 220, i: 5.33, r3: R3_STANDARD, initial: 0 },
                { id: 11, area: "Reserva Equipada (Rol, Taller)", v: 220, i: 7.16, r3: R3_STANDARD, initial: 0 },
                { id: 12, area: "Reserva Equipada (Gimnasio)", v: 220, i: 6.6, r3: R3_STANDARD, initial: 0 },
                { id: 13, area: "Bodega/Taller Intrum", v: 220, i: 24, r3: R3_STANDARD, initial: 0 },
                { id: 14, area: "EB100", v: 220, i: 12, r3: R3_STANDARD, initial: 60 }, // Corriente actualizada a 12A
                { id: 15, area: "Escuela Facilidades", v: 220, i: 7, r3: 1, initial: 100 }, // Raiz de 3 es 1 aquí
                { id: 16, area: "Bomba Captación Agua", v: 220, i: 4, r3: R3_STANDARD, initial: 50 }
            ]
        }
    ];

    // Función para calcular KVA base de un ítem
    function calculateKvaMax(item) {
        // Fórmula: (V * I * Raiz3) / 1000
        return (item.v * item.i * item.r3) / 1000;
    }

    // Función para obtener color basado en porcentaje (Verde -> Rojo)
    function getColorForPercentage(pct) {
        const hue = 120 - (pct * 1.2); 
        return `hsl(${hue}, 85%, 40%)`;
    }

    // Renderizado inicial de la tabla
    function render() {
        const container = document.getElementById('tables-container');
        container.innerHTML = '';

        data.forEach(section => {
            const sectionEl = document.createElement('div');
            sectionEl.className = 'table-section';
            
            let html = `
                <div class="section-title">
                    <span>${section.title}</span>
                    <span id="subtotal-${section.title.replace(/\s/g, '')}" style="color: var(--primary);">0.00 kVA</span>
                </div>
            `;

            section.items.forEach(item => {
                const kvaMax = calculateKvaMax(item);
                const iActual = (item.i * item.initial / 100);

                // Generamos IDs únicos para los elementos del DOM
                const rangeId = `range-${item.id}`;
                const numId = `num-${item.id}`;
                const resId = `res-${item.id}`;
                const currId = `curr-${item.id}`;

                html += `
                    <div class="load-row">
                        <div class="load-info">
                            <div>
                                <span class="area-name">${item.area}</span>
                                <div class="tech-specs">${item.v}V | I.Máx: ${item.i}A ${(item.r3 === 1 ? '| Monofásico' : '')}</div>
                            </div>
                            <div class="kva-vals">
                                <div style="color: var(--primary); font-weight: 700;">
                                    <span id="${currId}">${iActual.toFixed(1)}</span> A (Act.)
                                </div>
                                <div style="color: #94a3b8; font-size: 0.75rem;">Cap.Total: ${kvaMax.toFixed(2)} kVA</div>
                            </div>
                        </div>
                        <div class="control-group">
                            <input type="range" id="${rangeId}" min="0" max="100" step="5" 
                                value="${item.initial}" 
                                oninput="updateItem(${item.id}, this.value)">
                            <input type="number" class="percentage-input" 
                                id="${numId}"
                                value="${item.initial}" 
                                onchange="updateItem(${item.id}, this.value)"
                                style="color: ${getColorForPercentage(item.initial)}">
                            <div class="restricted-val" id="${resId}">
                                ${(kvaMax * item.initial / 100).toFixed(2)} kVA
                            </div>
                        </div>
                    </div>
                `;
            });

            sectionEl.innerHTML = html;
            container.appendChild(sectionEl);
        });
        updateTotals();
    }

    // Actualización al mover sliders o cambiar inputs
    function updateItem(id, value) {
        let val = parseInt(value);
        // Validación de entrada
        if (isNaN(val)) val = 0;
        if (val > 100) val = 100;
        if (val < 0) val = 0;

        data.forEach(section => {
            section.items.forEach(item => {
                if (item.id === id) {
                    item.initial = val; // Guardar nuevo estado
                    
                    const kvaMax = calculateKvaMax(item);
                    const kvaRestricted = kvaMax * (val / 100);
                    const iActual = (item.i * val / 100);
                    
                    // Actualizar elementos del DOM
                    document.getElementById(`range-${id}`).value = val;
                    const numInput = document.getElementById(`num-${id}`);
                    numInput.value = val;
                    numInput.style.color = getColorForPercentage(val);
                    
                    document.getElementById(`res-${id}`).innerText = kvaRestricted.toFixed(2) + " kVA";
                    document.getElementById(`curr-${id}`).innerText = iActual.toFixed(1);
                }
            });
        });

        updateTotals();
    }

    // Cálculo y actualización de totales generales
    function updateTotals() {
        let globalTotal = 0;

        data.forEach(section => {
            let sectionTotal = 0;
            section.items.forEach(item => {
                sectionTotal += calculateKvaMax(item) * (item.initial / 100);
            });
            globalTotal += sectionTotal;
            
            const subDisplay = document.getElementById(`subtotal-${section.title.replace(/\s/g, '')}`);
            if(subDisplay) subDisplay.innerText = sectionTotal.toFixed(2) + " kVA";
        });

        const usagePercentage = (globalTotal / GENERATOR_CAPACITY) * 100;

        // Actualizar Header sticky
        document.getElementById('total-kva').innerText = globalTotal.toFixed(2);
        document.getElementById('usage-percent').innerText = usagePercentage.toFixed(0) + "%";
        
        const progressEl = document.getElementById('main-progress');
        const summaryCard = document.getElementById('summary');
        const statusMsg = document.getElementById('status-msg');

        progressEl.style.width = Math.min(usagePercentage, 100) + "%";

        // Lógica de estados del generador
        if (usagePercentage > 100) {
            progressEl.style.backgroundColor = 'var(--danger)';
            summaryCard.classList.add('overload');
            statusMsg.innerHTML = "⚠️ ¡SOBRECARGA CRÍTICA! REDUCIR CARGAS INMEDIATAMENTE";
            statusMsg.style.color = 'var(--danger)';
        } else if (usagePercentage > 90) {
            progressEl.style.backgroundColor = 'var(--warning)';
            summaryCard.classList.remove('overload');
            statusMsg.innerHTML = "⚠️ Alerta: Capacidad al límite. Monitorear.";
            statusMsg.style.color = 'var(--warning)';
        } else if (usagePercentage > 80) {
            progressEl.style.backgroundColor = '#fbc02d'; // Amarillo oscuro
            summaryCard.classList.remove('overload');
            statusMsg.innerText = "Precaución: Carga alta.";
            statusMsg.style.color = '#f57c00';
        } else {
            progressEl.style.backgroundColor = 'var(--success)';
            summaryCard.classList.remove('overload');
            statusMsg.innerText = "Operación Normal / Carga Estable";
            statusMsg.style.color = 'var(--success)';
        }
    }

    // Inicializar aplicación
    window.onload = render;
</script>

</body>
</html>
